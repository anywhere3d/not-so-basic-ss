<!DOCTYPE html>
<html>
<head>
  <title></title>
</head>
<body>

  <script src="//cdn.peerjs.com/0.3/peer.js"></script>
  <script src="vendor/fingerprint2.js"></script>
  <script type="text/javascript">

    //object that abstracts communication with peers
    var allPeers;
    var AllPeers = function (array, peer){
      
      //remove master Id from peer list
      var i = array.indexOf(peer.id);
      array.splice(i, 1);
      this.list = array;

      this.poke = function(){

        //Send something to do to all peers
        this.list.forEach(function(peerId){

          var conn = peer.connect(peerId);
          conn.on('open', function (){
            conn.send('Do Something peer ' + peerId);
          });

        });        
      };
    };

    new Fingerprint2().get(function(fprint){
      
      try {
        createPeer(fprint);
      }
      catch (e) {
        console.error(e);
      }
    });


    function createPeer(fingerprint) {

      var namespace = window.location.pathname;
      var peer = new Peer(createPId(namespace, fingerprint), {host: location.hostname, port: 5000, path: '/api'});

      peer.on('open', function () {

        var ws = new WebSocket(location.origin.replace(/^http/, 'ws'));

        ws.onopen = function(event){
          ws.send(peer.id);
        };
        
        //Master peer will receive a message with the peer list
        ws.onmessage = function (msg) {
          var peersList = JSON.parse(msg.data);
          console.log('Master Peer!');

          allPeers = new AllPeers(peersList, peer);

          console.log('Current peers: ', allPeers.list);
        };
      });

      //Worker peer will receive something to do
      peer.on('connection', function (conn) {
        conn.on('data', function (data) {
          console.log('Received Peer data:', data);
        });
      });


    }

    function createPId (namespace, fp) {
      
      if (typeof namespace !== 'string') 
        throw 'namespace should be a string.';

      if (namespace === '/') 
        namespace = '/default/';

      if (typeof fp !== 'string') 
        throw 'Finger print format is not a string.';

      if ( fp === null) 
        throw 'Finger print is null.';

      if ( fp === undefined) 
        throw 'Finger print is undefined.';
     
      var prefix = namespace.split('/')[1];

      if (/^[a-z]+$/.test(prefix)) {
        var id = prefix + '-' + fp + Date.now() + Math.floor( Math.random()*1000);
        return id;        
      } else {
        throw 'Prefix not supported. Only letters  \'a\' to \'z\' ';
      } 
    }

  </script>

</body>
</html>

